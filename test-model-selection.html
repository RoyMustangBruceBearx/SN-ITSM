<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å‹é€‰æ‹©åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #FF1493;
            padding-bottom: 10px;
        }
        button {
            background: linear-gradient(135deg, #FF69B4, #FF1493);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            opacity: 0.9;
        }
        .result {
            background: #f9f9f9;
            padding: 15px;
            margin-top: 10px;
            border-radius: 6px;
            border-left: 4px solid #FF1493;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            color: #10b981;
        }
        .error {
            color: #ef4444;
        }
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin: 10px 0;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª æ¨¡å‹é€‰æ‹©åŠŸèƒ½æµ‹è¯•</h1>

    <div class="test-section">
        <h2>1. æµ‹è¯•è·å–æ¨¡å‹åˆ—è¡¨</h2>
        <p>æµ‹è¯•æ¥å£ï¼š<code>GET http://47.236.87.251:3000/api/models</code></p>
        <button onclick="testGetModels()">è·å–æ¨¡å‹åˆ—è¡¨</button>
        <div id="modelsResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. æµ‹è¯•æ¨¡å‹é€‰æ‹©</h2>
        <label>é€‰æ‹©æ¨¡å‹ï¼š</label>
        <select id="modelSelect">
            <option value="">è¯·å…ˆè·å–æ¨¡å‹åˆ—è¡¨</option>
        </select>
        <div id="selectedModel" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. æµ‹è¯•èŠå¤©æ¥å£</h2>
        <p>æµ‹è¯•æ¥å£ï¼š<code>POST http://47.236.87.251:3000/api/chat/completions</code></p>
        <label>è¾“å…¥æ¶ˆæ¯ï¼š</label>
        <input type="text" id="chatMessage" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯" value="ä½ å¥½å•Š">
        <button onclick="testChat()">å‘é€æ¶ˆæ¯</button>
        <div id="chatResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>4. å®Œæ•´æµç¨‹æµ‹è¯•</h2>
        <button onclick="testFullFlow()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <div id="fullFlowResult" class="result"></div>
    </div>

    <script>
        let availableModels = [];

        // æµ‹è¯•è·å–æ¨¡å‹åˆ—è¡¨
        async function testGetModels() {
            const resultDiv = document.getElementById('modelsResult');
            resultDiv.innerHTML = 'æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...';

            try {
                const response = await fetch('http://47.236.87.251:3000/api/models', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('APIè¿”å›æ•°æ®:', data);

                // è§£ææ¨¡å‹åˆ—è¡¨
                let models = [];
                if (data.data && Array.isArray(data.data)) {
                    models = data.data.map(model => ({
                        id: model.id,
                        name: model.name || model.id
                    }));
                } else if (Array.isArray(data)) {
                    models = data.map(model => ({
                        id: model.id,
                        name: model.name || model.id
                    }));
                }

                availableModels = models;

                // æ›´æ–°ä¸‹æ‹‰æ¡†
                const modelSelect = document.getElementById('modelSelect');
                modelSelect.innerHTML = models.map(model => 
                    `<option value="${model.id}">${model.name}</option>`
                ).join('');

                // æ˜¾ç¤ºç»“æœ
                resultDiv.innerHTML = `<span class="success">âœ“ æˆåŠŸè·å– ${models.length} ä¸ªæ¨¡å‹</span>\n\n` +
                    JSON.stringify(models, null, 2);

                // ç›‘å¬é€‰æ‹©å˜åŒ–
                modelSelect.onchange = function() {
                    const selectedModel = models.find(m => m.id === this.value);
                    document.getElementById('selectedModel').innerHTML = 
                        `<span class="success">å·²é€‰æ‹©æ¨¡å‹ï¼š</span>\n` +
                        `ID: ${selectedModel.id}\n` +
                        `Name: ${selectedModel.name}`;
                };

            } catch (error) {
                console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
                resultDiv.innerHTML = `<span class="error">âœ— å¤±è´¥ï¼š${error.message}</span>`;
            }
        }

        // æµ‹è¯•èŠå¤©æ¥å£
        async function testChat() {
            const resultDiv = document.getElementById('chatResult');
            const modelSelect = document.getElementById('modelSelect');
            const messageInput = document.getElementById('chatMessage');

            const modelId = modelSelect.value;
            const message = messageInput.value.trim();

            if (!modelId) {
                resultDiv.innerHTML = '<span class="error">âœ— è¯·å…ˆé€‰æ‹©æ¨¡å‹</span>';
                return;
            }

            if (!message) {
                resultDiv.innerHTML = '<span class="error">âœ— è¯·è¾“å…¥æ¶ˆæ¯</span>';
                return;
            }

            resultDiv.innerHTML = 'æ­£åœ¨å‘é€æ¶ˆæ¯...';

            try {
                const requestData = {
                    model: modelId,
                    messages: [
                        {
                            role: "user",
                            content: message
                        }
                    ]
                };

                console.log('å‘é€è¯·æ±‚:', requestData);

                const response = await fetch('http://47.236.87.251:3000/api/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('APIè¿”å›æ•°æ®:', data);

                const aiResponse = data.choices?.[0]?.message?.content || 'æ— å›å¤å†…å®¹';

                resultDiv.innerHTML = `<span class="success">âœ“ å‘é€æˆåŠŸ</span>\n\n` +
                    `ä½¿ç”¨æ¨¡å‹: ${modelId}\n` +
                    `ç”¨æˆ·æ¶ˆæ¯: ${message}\n` +
                    `AIå›å¤: ${aiResponse}\n\n` +
                    `å®Œæ•´å“åº”:\n${JSON.stringify(data, null, 2)}`;

            } catch (error) {
                console.error('èŠå¤©å¤±è´¥:', error);
                resultDiv.innerHTML = `<span class="error">âœ— å¤±è´¥ï¼š${error.message}</span>`;
            }
        }

        // å®Œæ•´æµç¨‹æµ‹è¯•
        async function testFullFlow() {
            const resultDiv = document.getElementById('fullFlowResult');
            resultDiv.innerHTML = 'å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯•...\n\n';

            try {
                // æ­¥éª¤1: è·å–æ¨¡å‹åˆ—è¡¨
                resultDiv.innerHTML += 'æ­¥éª¤1: è·å–æ¨¡å‹åˆ—è¡¨...\n';
                await testGetModels();
                await sleep(1000);

                if (availableModels.length === 0) {
                    throw new Error('æœªè·å–åˆ°æ¨¡å‹åˆ—è¡¨');
                }

                resultDiv.innerHTML += `<span class="success">âœ“ è·å–åˆ° ${availableModels.length} ä¸ªæ¨¡å‹</span>\n\n`;

                // æ­¥éª¤2: é€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹
                const firstModel = availableModels[0];
                document.getElementById('modelSelect').value = firstModel.id;
                resultDiv.innerHTML += `æ­¥éª¤2: é€‰æ‹©æ¨¡å‹ ${firstModel.name} (${firstModel.id})\n`;
                resultDiv.innerHTML += `<span class="success">âœ“ æ¨¡å‹å·²é€‰æ‹©</span>\n\n`;

                await sleep(1000);

                // æ­¥éª¤3: å‘é€æµ‹è¯•æ¶ˆæ¯
                resultDiv.innerHTML += 'æ­¥éª¤3: å‘é€æµ‹è¯•æ¶ˆæ¯...\n';
                document.getElementById('chatMessage').value = 'ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±';
                await testChat();

                resultDiv.innerHTML += '\n<span class="success">âœ“ å®Œæ•´æµç¨‹æµ‹è¯•å®Œæˆï¼</span>';

            } catch (error) {
                console.error('å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥:', error);
                resultDiv.innerHTML += `\n<span class="error">âœ— æµ‹è¯•å¤±è´¥ï¼š${error.message}</span>`;
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•æ¨¡å‹é€‰æ‹©åŠŸèƒ½');
        };
    </script>
</body>
</html>
