# 模型选择功能修复说明

## 问题描述
模型选择功能不正确，需要：
1. 调用接口 `http://47.236.87.251:3000/api/models` 获取模型清单
2. 从返回数据中提取 `id` 和 `name`，ID 对应 name 进行存储
3. 在下拉菜单中展示用 `name`，传输其他接口用 `id`
4. 调用聊天接口 `http://47.236.87.251:3000/api/chat/completions` 时，使用选中的模型 `id`

## 修复内容

### 1. AIService.js - 获取模型列表

**文件路径：** `shengnong-platform-v2/src/services/aiService.js`

**修改的方法：** `getModels()`

**修改内容：**
```javascript
async getModels() {
  try {
    console.log('正在从API获取模型列表:', `${this.config.baseUrl}/models`)
    
    const response = await fetch(`${this.config.baseUrl}/models`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`)
    }
    
    const data = await response.json()
    console.log('API返回的模型数据:', data)
    
    // 提取id和name，返回格式化的模型列表
    if (data.data && Array.isArray(data.data)) {
      const models = data.data.map(model => ({
        id: model.id,
        name: model.name || model.id
      }))
      console.log('解析后的模型列表:', models)
      return models
    }
    
    // 如果data本身就是数组
    if (Array.isArray(data)) {
      const models = data.map(model => ({
        id: model.id,
        name: model.name || model.id
      }))
      console.log('解析后的模型列表:', models)
      return models
    }
    
    console.warn('API返回的数据格式不正确，使用默认模型列表')
    return []
    
  } catch (error) {
    console.error('获取模型列表失败:', error)
    return []
  }
}
```

**关键改进：**
- ✅ 添加详细的日志输出，便于调试
- ✅ 支持两种数据格式：`{data: [...]}` 和直接数组 `[...]`
- ✅ 正确提取 `id` 和 `name` 字段
- ✅ 失败时返回空数组而不是默认列表

### 2. AIService.js - 构建请求数据

**修改的方法：** `buildRequestData()`

**修改内容：**
```javascript
buildRequestData(message, context, options = {}) {
  const messages = [
    ...context,
    { role: 'user', content: message }
  ]
  
  const requestData = {
    model: this.config.model,  // 使用配置中的模型ID
    messages,
    max_tokens: this.config.maxTokens,
    temperature: this.config.temperature,
    stream: options.stream || false,
    ...options
  }
  
  console.log('构建请求数据:', {
    model: requestData.model,
    messagesCount: messages.length,
    stream: requestData.stream
  })
  
  return requestData
}
```

**关键改进：**
- ✅ 添加日志输出，显示使用的模型 ID
- ✅ 确保使用 `this.config.model`（即保存的模型 ID）

### 3. HomePage.js - 保存API设置

**文件路径：** `shengnong-platform-v2/src/pages/HomePage.js`

**修改的方法：** `saveAPISettings()`

**修改内容：**
```javascript
async saveAPISettings(aiSidebar) {
  try {
    const apiUrlInput = aiSidebar.querySelector('#apiUrlInput')
    const modelSelect = aiSidebar.querySelector('#modelSelect')
    const maxTokensInput = aiSidebar.querySelector('#maxTokensInput')
    const temperatureInput = aiSidebar.querySelector('#temperatureInput')
    
    const apiUrl = apiUrlInput?.value?.trim()
    const model = modelSelect?.value  // 这是模型的ID
    const maxTokens = parseInt(maxTokensInput?.value)
    const temperature = parseFloat(temperatureInput?.value)
    
    console.log('保存API设置:', { apiUrl, model, maxTokens, temperature })
    
    if (!apiUrl) {
      throw new Error('请输入API地址')
    }
    
    if (!model) {
      throw new Error('请选择模型')
    }
    
    const aiConfig = {
      baseUrl: apiUrl,
      model,  // 保存的是模型ID
      maxTokens,
      temperature
    }
    
    await this.configService.setConfig('ai', aiConfig)
    
    // 更新AI服务配置
    if (this.aiService) {
      this.aiService.updateConfig(aiConfig)
      console.log('AI服务配置已更新，当前模型ID:', model)
    }
    
    this.closeAPISettings(aiSidebar)
    this.showNotification('API设置已保存！', 'success')
    
  } catch (error) {
    console.error('保存API设置失败:', error)
    this.showNotification(error.message, 'error')
  }
}
```

**关键改进：**
- ✅ 添加模型验证，确保选择了模型
- ✅ 添加详细日志，显示保存的模型 ID
- ✅ 保存后立即更新 AIService 配置

### 4. AIAssistantPage.js - 保存设置

**文件路径：** `shengnong-platform-v2/src/pages/AIAssistantPage.js`

**修改的方法：** `saveSettings()`

**修改内容：**
```javascript
async saveSettings() {
  try {
    const apiUrl = this.container?.querySelector('#apiUrl')?.value?.trim()
    const model = this.container?.querySelector('#modelSelect')?.value  // 这是模型的ID
    const maxTokens = parseInt(this.container?.querySelector('#maxTokens')?.value)
    const temperature = parseFloat(this.container?.querySelector('#temperature')?.value)
    
    console.log('保存API设置:', { apiUrl, model, maxTokens, temperature })
    
    if (!apiUrl) {
      throw new Error('请输入API地址')
    }
    
    if (!model) {
      throw new Error('请选择模型')
    }
    
    const oldBaseUrl = this.configService?.getConfig('ai')?.baseUrl
    
    const aiConfig = {
      baseUrl: apiUrl,
      model,  // 保存的是模型ID
      maxTokens,
      temperature
    }
    
    await this.configService.setConfig('ai', aiConfig)
    
    // 更新AI服务配置
    if (this.aiService) {
      this.aiService.updateConfig(aiConfig)
      console.log('AI服务配置已更新，当前模型ID:', model)
    }
    
    // 如果API地址改变了，重新加载模型列表
    if (oldBaseUrl !== apiUrl) {
      console.log('API地址已更改，重新加载模型列表...')
      await this.loadModels()
    }
    
    this.closeAPISettings()
    this.showNotification('API设置已保存！', 'success')
    
  } catch (error) {
    console.error('保存API设置失败:', error)
    this.showNotification(error.message, 'error')
  }
}
```

**关键改进：**
- ✅ 添加模型验证
- ✅ 添加详细日志
- ✅ 保存后立即更新 AIService 配置

## 工作流程

### 1. 初始化时加载模型列表
```
页面初始化 → loadModels() → AIService.getModels() 
→ 调用 GET /api/models 
→ 解析返回的 {id, name} 
→ 更新下拉框（显示 name，值为 id）
```

### 2. 用户选择模型并保存
```
用户选择模型 → 点击保存 → saveAPISettings() 
→ 获取 modelSelect.value（这是 id）
→ 保存到 config.ai.model 
→ 更新 AIService.config.model
```

### 3. 发送聊天消息
```
用户发送消息 → sendMessage() → AIService.sendMessage() 
→ buildRequestData() 使用 this.config.model（即保存的 id）
→ POST /api/chat/completions 
→ 请求体包含 { model: "id", messages: [...] }
```

## 数据流示例

### API 返回的模型数据格式
```json
{
  "data": [
    {
      "id": "qwen2.5:7b",
      "name": "Qwen2.5 7B"
    },
    {
      "id": "gpt-3.5-turbo",
      "name": "GPT-3.5 Turbo"
    }
  ]
}
```

### 解析后的模型列表
```javascript
[
  { id: "qwen2.5:7b", name: "Qwen2.5 7B" },
  { id: "gpt-3.5-turbo", name: "GPT-3.5 Turbo" }
]
```

### 下拉框 HTML
```html
<select id="modelSelect">
  <option value="qwen2.5:7b">Qwen2.5 7B</option>
  <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
</select>
```

### 聊天请求数据
```json
{
  "model": "qwen2.5:7b",
  "messages": [
    {
      "role": "user",
      "content": "你好啊"
    }
  ]
}
```

## 测试方法

### 方法1: 使用测试页面
1. 打开 `test-model-selection.html`
2. 点击"获取模型列表"按钮
3. 查看返回的模型数据
4. 选择一个模型
5. 输入测试消息并发送
6. 查看请求和响应数据

### 方法2: 在实际应用中测试
1. 启动开发服务器：`npm run dev`
2. 打开浏览器控制台（F12）
3. 点击神农晓问浮动按钮
4. 点击齿轮图标打开配置
5. 查看控制台日志，确认模型列表加载
6. 选择一个模型并保存
7. 发送测试消息
8. 查看控制台日志，确认使用的模型 ID

### 预期的控制台日志
```
正在从API获取模型列表: http://47.236.87.251:3000/api/models
API返回的模型数据: {data: [...]}
解析后的模型列表: [{id: "...", name: "..."}, ...]
模型列表加载完成: [{id: "...", name: "..."}, ...]
保存API设置: {apiUrl: "...", model: "qwen2.5:7b", ...}
AI服务配置已更新，当前模型ID: qwen2.5:7b
构建请求数据: {model: "qwen2.5:7b", messagesCount: 2, stream: false}
```

## 验证清单

- ✅ 调用 `/api/models` 接口获取模型列表
- ✅ 正确解析返回的 `id` 和 `name` 字段
- ✅ 下拉框显示 `name`，值为 `id`
- ✅ 保存配置时存储模型 `id`
- ✅ 发送聊天消息时使用模型 `id`
- ✅ 添加详细的日志输出便于调试
- ✅ 添加错误处理和验证

## 注意事项

1. **模型 ID 的使用**：始终使用 `id` 字段作为模型标识符，`name` 仅用于显示
2. **配置持久化**：模型 ID 会保存到 localStorage，下次打开时自动加载
3. **错误处理**：如果获取模型列表失败，返回空数组，不影响其他功能
4. **日志输出**：所有关键步骤都有日志输出，便于排查问题

## 完成状态
✅ **功能已修复** - 模型选择功能现在正确地从 API 获取模型列表，并在聊天时使用正确的模型 ID。

---
**完成时间：** 2025-01-16
**修改者：** Kiro AI Assistant
